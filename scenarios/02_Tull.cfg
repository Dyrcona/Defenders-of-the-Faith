#textdomain wesnoth-Dyrcona_DotF

#define PLACE_BUILDINGS
    # I tried using [terrain_graphics] for these, but I do not
    # understand it yet.
    {PLACE_IMAGE terrain/village/human2.png 14 24}
    {PLACE_IMAGE terrain/village/human4.png 6 34}
    {PLACE_IMAGE terrain/village/human2.png 2 38}
    {PLACE_IMAGE terrain/village/log-cabin.png 5 38}
    {PLACE_IMAGE scenery/temple1.png 7 38}
    {PLACE_IMAGE terrain/village/human-city.png 11 38}
#enddef

#define REPLACE_JETHROS_HOUSE
    {REMOVE_IMAGE 14 24}
    {PLACE_IMAGE scenery/village-human-burned1.png 14 24}
    [if]
        [have_unit]
            side=1
            id=Jethro
        [/have_unit]
        [variable]
            name=back_to_the_family
            boolean_equals=no
        [/variable]
        [then]
            [item]
                x,y=14,24
                halo=items/gohere-empty.png
            [/item]
        [/then]
    [/if]
#enddef

#define REPLACE_TEMPLE
    {REMOVE_IMAGE 7 38}
    {PLACE_IMAGE scenery/temple-cracked3.png 7 38}
    [if]
        [variable]
            name=tull
            boolean_equals=no
        [/variable]
        [then]
            [item]
                x,y=7,38
                halo=items/gohere-empty.png
            [/item]
        [/then]
    [/if]
#enddef

#define REPLACE_BUILDINGS
    {REMOVE_IMAGE 6 34}
    {REMOVE_IMAGE 2 38}
    {REMOVE_IMAGE 5 38}
    {REMOVE_IMAGE 11 38}
    {REPLACE_JETHROS_HOUSE}
    {REPLACE_TEMPLE}
    {PLACE_IMAGE scenery/village-human-burned4.png 6 34}
    {PLACE_IMAGE scenery/village-human-burned3.png 2 38}
    {PLACE_IMAGE scenery/village-human-burned1.png 5 38}
    {PLACE_IMAGE scenery/village-human-burned2.png 11 38}
#enddef

#define FIRE_JETHRO_PLAGUE_CONVO
    [if]
        [have_unit]
            side=1
            id=Jethro
        [/have_unit]
        [variable]
            name=jethro_knows_about_plague
            boolean_equals=false
        [/variable]
        [then]
            [fire_event]
                name=jethro_plague_convo
            [/fire_event]
        [/then]
    [/if]
#enddef

[scenario]
    id=02_Tull
    name= _ "Village of Tull"
    next_scenario=03_Begars_Farm
    map_file=02_Tull.map
    victory_when_enemies_defeated=no
    turns=48
    {INTRO_AND_SCENARIO_MUSIC "transience.ogg" "the_city_falls.ogg"}
    {MORNING}

    # With 1 turn representing 10 minutes, I'm basically giving the
    # player 8 game hours to complete this. That would be a full
    # morning and afternoon cycle. I originally had no turn limit, but
    # found that adding a high turn limit will still allow the player
    # to rest the group between fights and give them time to explore
    # the map.
    #
    # Afternoon comes on arbitrarily when the player team crosses the
    # bridge, technically when a unit enters the hex at 10, 15.
    # There's a brief conversation about the village having burned and
    # the smoke/haze gets thicker. The buildings in the village are
    # replaced with burned and ruined versions of the originals.

    {GRAPVIN_SIDE INCOME=-2}

    [side]
        no_leader=yes
        side=2
        color=black
        {UNDEAD_TEAM}
        hidden=yes
        fog=yes
        [ai]
            grouping=no
            aggression=1.0
            caution=0.0
        [/ai]
    [/side]

    [side]
        no_leader=yes
        side=3
        team_name=wildlife
        hidden=yes
        color=brown
        fog=yes
        # Boars are dumb and attack the units closest to their nest.
        [ai]
            [micro_ai]
                ai_type=simple_attack
                action=add
                [filter]
                    type=Woodland Boar
                [/filter]
                [filter_second]
                    lua_function="closest_to_nest"
                [/filter_second]
            [/micro_ai]
        [/ai]
    [/side]

    [side]
        side=4
        no_leader=yes
        team_name=defenders,undead # So the undead don't go for him early.
        color=white
        hidden=yes
        controller=null
        share_vision=none
    [/side]

    {PLACE_BUILDINGS}
    {PLACE_IMAGE scenery/trash.png 5 9}
    {PLACE_IMAGE scenery/rock4.png 11 29}
    {PLACE_IMAGE scenery/monolith1.png 20 11}

    [story]
        [part]
            background=story/landscape-bridge.webp
            scale_background=yes
            story= _ "High Priest Wisserl of the Church of Light has dispatched Sergeant Grapvin and Initiate Niraliza to the village of Tull to meet with the curate, Brother Jehan, and investigate the strange happenings there."
        [/part]
        [part]
            background=story/landscape-bridge.webp
            scale_background=yes
            story= _ "After riding for four days, the duo arrive on the outskirts of the village."
        [/part]
    [/story]

    [event]
        name=preload
        first_time_only=no
        [lua]
            code=<<
            local AIH = wesnoth.require("ai/lua/ai_helper.lua")
            function closest_to_nest(unit)
                local nest_loc = {5,9}
                local potential = AIH.get_closest_enemy(nest_loc)
                return unit == potential
            end
            >>
        [/lua]
    [/event]

    [event]
        name=prestart
        {VARIABLE tull no}
        {VARIABLE back_to_the_family no}
        {VARIABLE jethro_expendable no}
        {VARIABLE jethro_knows_about_plague no}
        {VARIABLE boar_kill_count 0}
        {VARIABLE is_afternoon no}
        {RECALL Niraliza}
        [unit]
            x,y=9,5
            side=4
            {CHARACTER_STATS_JETHRO}
        [/unit]
        {SCATTER_CORPSE_VARIATIONS {ON_DIFFICULTY4 2 4 6 8} (Walking Corpse) (wolf)
        {ON_DIFFICULTY4 6 6 4 2}
        (terrain=Gll^Fmf
        x=11-24
        y=1-15) (side=2)}
    [/event]

    [event]
        name=start
        # Represent the smoke of the burning buildings
        {COLOR_ADJUST -10 -10 -10}
        {HIGHLIGHT_IMAGE 7 38 items/gohere-empty.png scenery/temple1.png}
        [message]
            speaker=Grapvin
            message= _ "We should reach Tull in the afternoon according to our map."
        [/message]
        [message]
            speaker=Niraliza
            message= _ "Hmm.... Do you smell the smoke? Something is burning."
        [/message]

        [objectives]
            side=1
            [objective]
                description= _ "Reach the temple in the village of Tull."
                condition=win
                [show_if]
                    [variable]
                        name=tull
                        boolean_not_equals=yes
                    [/variable]
                [/show_if]
            [/objective]
            [objective]
                description= _ "Go with Jethro to Begar's farm."
                condition=win
                [show_if]
                    [variable]
                        name=tull
                        boolean_equals=yes
                    [/variable]
                [/show_if]
            [/objective]
            [objective]
                {BONUS_OBJECTIVE_CAPTION}
                description= _ "Help Jethro reach his home."
                condition=win
                [show_if]
                    [have_unit]
                        side=1
                        id=Jethro
                    [/have_unit]
                    [variable]
                        name=back_to_the_family
                        boolean_not_equals=yes
                    [/variable]
                [/show_if]
            [/objective]
            {TURNS_RUN_OUT}
            {OBJECTIVE_HERODEATHS}
            [gold_carryover]
                bonus=no
                carryover_percentage=100
            [/gold_carryover]
        [/objectives]
    [/event]

    # Sighted events for Jethro and undead.
    [event]
        name=sighted
        [filter]
            side=4
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [message]
            speaker=second_unit
            message= _ "Hail, fellow traveler!"
        [/message]
        [message]
            speaker=unit
            message= _ "Well met friends! I see by your colors that you serve the light.

Are ye headed for Tull?"
        [/message]
        [message]
            speaker=second_unit
            message= _ "Indeed, we are."
        [/message]
        [message]
            speaker=unit
            message= _ "Name's $unit.name. I'm returning to Tull after a hunting trip. With these wolves and wild boars about, it's getting to be much too dangerous for an old coot like me. I think it would be safer if we traveled together. Would ya mind helping me get back to the family in Tull?"
        [/message]
        {WITH_UNIT (id=Grapvin) grapvin
        ([message]
            speaker=Grapvin
            message= _ "I am $grapvin.type Grapvin, and my companion is Sister Niraliza. We would be glad of your company."
        [/message])}
        [message]
            speaker=unit
            message= _ "Thank ya. I am much obliged."
        [/message]
        [modify_unit]
            [filter]
                side=4
            [/filter]
            side=1
        [/modify_unit]
        [show_objectives]
            side=1
        [/show_objectives]
        [if]
            [variable]
                name=is_afternoon
                boolean_equals=yes
            [/variable]
            [then]
                {HIGHLIGHT_IMAGE 14 24 items/gohere-empty.png scenery/village-human-burned1.png}
            [/then]
            [else]
                {HIGHLIGHT_IMAGE 14 24 items/gohere-empty.png terrain/village/human2.png}
            [/else]
        [/if]
    [/event]
    [event]
        name=sighted
        [filter]
            side=2
            variation=wolf
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [message]
            speaker=Grapvin
            message= _ "Isn't it odd for wolves to be roaming about this time of day?"
        [/message]
        [if]
            [have_unit]
                side=1
                id=Jethro
            [/have_unit]
            [then]
                [message]
                    speaker=Jethro
                    message= _ "Yes, and that wolf don't look right. It must have some kind of sickness."
                [/message]
                [message]
                    speaker=Niraliza
                    message= _ "The poor thing does appear odd, like a ... walking corpse. Perhaps the plague that Brother Jehan reported has affected the wolves as well."
                [/message]
                {FIRE_JETHRO_PLAGUE_CONVO}
            [/then]
            [else]
                [message]
                    speaker=Niraliza
                    message= _ "Yes, I think so, and note it's odd appearance, almost like a ... walking corpse. Do you think the plague that Brother Jehan reported could affect the wildlife, too?"
                [/message]
                [message]
                    speaker=Grapvin
                    message= _ "It's quite possible, but you would know more about that than I."
                [/message]
            [/else]
        [/if]
    [/event]
    [event]
        name=sighted
        id=undead_human_sighted
        [filter]
            side=2
            [not]
                variation=wolf,horse
            [/not]
            [not]
                id=Hagwylyn,Brother_Jehan
            [/not]
        [/filter]
        [filter_second]
            side=1
            [not]
                id=Jethro
            [/not]
        [/filter_second]
        [message]
            speaker=Niraliza
            message= _ "This poor soul must be a victim of the plague."
        [/message]
        {FIRE_JETHRO_PLAGUE_CONVO}
    [/event]
    [event]
        name=sighted
        id=undead_human_sighted_jethro
        [filter]
            side=2
            [not]
                variation=wolf,horse
            [/not]
            [not]
                id=Hagwylyn,Brother_Jehan
            [/not]
        [/filter]
        [filter_second]
            side=1
            id=Jethro
        [/filter_second]
        [message]
            speaker=second_unit
            message= _ "What's wrong with that feller? He looks sick...almost dead."
        [/message]
        [message]
            speaker=Niraliza
            message= _ "This poor soul must be a victim of the plague."
        [/message]
        {FIRE_JETHRO_PLAGUE_CONVO}
    [/event]
    [event]
        name=sighted
        id=undead_horse_sigthed
        [filter]
            side=2
            variation=horse
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        # I'm tired of making extra events just for Jethro.
        [message]
            speaker=Niraliza
            message= _ "The plague must also affect horses."
        [/message]
        {FIRE_JETHRO_PLAGUE_CONVO}
    [/event]
    [event]
        name=jethro_plague_convo
        [message]
            speaker=Jethro
            message= _ "What's this about plague?"
        [/message]
        [message]
            speaker=Niraliza
            message= _ "We were dispatched by the High Priest Wisserl of the Temple of Light in the Capitol to investigate reports of a plague afflicting the people of Tull."
        [/message]
        [message]
            speaker=Jethro
            message= _ "A plague you say...."
        [/message]
        {VARIABLE jethro_knows_about_plague true}
    [/event]

    # Afternoon trigger 
    [event]
        name=enter_hex
        [filter]
            side=1
            x,y=10,15
        [/filter]
        [replace_schedule]
            {AFTERNOON}
        [/replace_schedule]
        {VARIABLE is_afternoon yes}
        {REPLACE_BUILDINGS}
        {SCATTER_CORPSE_VARIATIONS
            {ON_DIFFICULTY4 4 8 8 8}
            {ON_DIFFICULTY4 (Walking Corpse) (Walking Corpse) (Walking Corpse,Soulless) (Soulless)}
            (none,wolf,horse)
            6
            (terrain=Gll^Fmf,Rb^Gvs
             x=1-24
             y=21-40)
            (side=2)}
        [message]
            speaker=Niraliza
            message= _ "The smoke gets thicker as we get nearer to the village."
        [/message]
        [message]
            speaker=Grapvin
            message= _ "Small wonder. It appears that the village has burned."
        [/message]
        [message]
            speaker=Jethro
            message= _ "My home..."
        [/message]
        {COLOR_ADJUST -20 -20 -20}
    [/event]

    # Dusk trigger, but don't change is_afternoon value
    [event]
        name=turn 42
        [replace_schedule]
            {DUSK}
        [/replace_schedule]
        [if]
            [variable]
                name=tull
                boolean_equals=yes
            [/variable]
            [then]
                [message]
                    speaker=Jethro
                    message= _ "It is dusk. We gotta hurry if we're going to see Begar before nightfall."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Niraliza
                    message= _ "We have not yet reached the temple. We must hurry."
                [/message]
            [/else]
        [/if]
    [/event]

    # Time over, you lose.
    [event]
        name=time_over
        [filter_condition]
            [variable]
                name=tull
                boolean_equals=yes
            [/variable]
        [/filter_condition]
        [message]
            speaker=Jethro
            message= _ "Night falls, and we haven't made it to Begar's farm. We are doomed."
        [/message]
    [/event]
    [event]
        name=time_over
        [filter_condition]
            [variable]
                name=tull
                boolean_equals=no
            [/variable]
        [/filter_condition]
        [message]
            speaker=Niraliza
            message= _ "Night falls and we have not spoken to Brother Jehan at the temple. We have failed in our duty."
        [/message]
    [/event]

    # Boars
    [event]
        name=enter_hex
        [filter]
            side=1
            x,y=5,9
        [/filter]
        [message]
            speaker=unit
            message= _ "Oh, no! I have stumbled upon a boar's nest!"
        [/message]
        [cancel_action][/cancel_action]
        {NOTRAIT_UNIT 3 (Woodland Boar) 4 9}
    [/event]

    # A monolith, for DiD fans
    [event]
        name=moveto
        [filter]
            side=1
            x,y=20,11
        [/filter]
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "The inscription on this ancient monolith has weathered away and is impossible to read."
        [/message]
    [/event]

    # A "friendly" wolf for you to tame or not.
    [event]
        name=enter_hex
        [filter]
            side=1
            x=22,22
            y=5,6
        [/filter]
        [unit]
            side=3
            type=Wolf
            id=friendly_wolf
            x=23
            y=5
            random_traits=no
            [modifications]
                {TRAIT_STRONG}
            [/modifications]
        [/unit]
        [if]
            [have_unit]
                side=1
                id=Jethro
            [/have_unit]
            [variable]
                name=boar_kill_count
                greater_than=0
            [/variable]
            [then]
                [message]
                    speaker=Jethro
                    message= _ "That critter looks hungry. If we give it some boar meat, maybe it'll be friendly."
                    [option]
                        message= _ "Offer the boar meat to the wolf."
                        [command]
                            [fire_event]
                                name=wolf_joins
                            [/fire_event]
                        [/command]
                    [/option]
                    [option]
                        message= _ "Save the boar meat for yourselves."
                    [/option]
                [/message]
            [/then]
            [else]
                [message]
                    speaker=second_unit
                    message=_ "A wolf!"
                [/message]
            [/else]
        [/if]
        [cancel_action][/cancel_action]
    [/event]

    [event]
        name=wolf_joins
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "You offer the fresh boar meat to the wolf, who accepts it warily, then gobbles it down.

The wolf wags its tail and approaches you cautiously.

You reach out to pet it, and the wolf permits your touch.

You have found a new pet."
            sound=wolf-hit-2.ogg
        [/message]
        [gold]
            side=1
            amount=-10
        [/gold]
        [modify_unit]
            [filter]
                side=3
                type=Wolf
            [/filter]
            side=1
            {TRAIT_LOYAL}
        [/modify_unit]
    [/event]

    # Jethro's quest
    [event]
        name=enter_hex
        [filter]
            side=1
            x,y=14,24
        [/filter]
        [cancel_action][/cancel_action]
        [unit]
            side=2
            type=Walking Corpse
            id=Hagwylyn
            name= _ "female^Hagwylyn"
            x=15
            y=24
        [/unit]
        [message]
            speaker=Jethro
            message= _ "Hagwylyn, no!"
        [/message]
        [remove_event]
            id=undead_human_sighted,undead_human_sigthed_jethro
        [/remove_event]
        [remove_item]
            x,y=14,24
            halo=items/gohere-empty.png
        [/remove_item]
        {PLACE_IMAGE scenery/village-human-burned1.png 14 24}
    [/event]
    # Bonus Objective succeeded
    [event]
        name=die
        [filter]
            side=2
            id=Hagwylyn
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [if]
            [variable]
                name=jethro_knows_about_plague
                boolean_equals=yes
            [/variable]
            [then]
                [message]
                    speaker=Jethro
                    message= _ "<i>Sobbing.</i> Hagwylyn, why? Why didya have to get the plague?"
                [/message]
                [message]
                    speaker=Niraliza
                    message= _ "You have our condolences and deepest sypmathies over your loss. If it is any consolation be assured that your wife's soul is in a better place now."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Jethro
                    message= _ "What happened? What happened to my dear wife, Hagwylyn?"
                [/message]
                [message]
                    speaker=Niraliza
                    message= _ "I am afrad that she must have succumbed to the plague, Jethro. Rest assured knowing that her soul is in a better place now."
                [/message]
                {FIRE_JETHRO_PLAGUE_CONVO}
            [/else]
        [/if]
        [message]
            speaker=Jethro
            message= _ "Since I've no home nor family to return to, I might as well accompany you two on your mission. Perhaps I can find a new life when it is done."
        [/message]
        [message]
            speaker=Grapvin
            message= _ "Given the circumstances, I think you should join us. We will all be safer together."
        [/message]
        # Not going to award Jethro (it's his quest), nor the killer
        # (they got the XP for killing Hagwylyn).--Yes, even the wolf.
        {AWARD_EXPERIENCE
            (side=1
             [not]
                 id=Jethro,$second_unit.id
             [/not])
             4
             (MSG= _ "Some of your units were awarded experience for helping Jethro.")}
        {VARIABLE back_to_the_family yes}
    [/event]

    # Player made it, they think.
    [event]
        name=enter_hex
        [filter]
            side=1
            x=7
            y=38
        [/filter]
        [cancel_action][/cancel_action]
        # The player should think they're going to win, but there's a
        # surprise waiting for them.
        [unit]
            side=2
            type=Soulless
            x=7
            y=37
            id=Brother_Jehan
            name= _ "Brother Jehan"
        [/unit]
        [remove_event]
            id=undead_human_sighted,undead_human_sigthed_jethro
        [/remove_event]
        [message]
            speaker=Niraliza
            message= _ "Oh, no! Brother Jehan must have succumbed to the plague!"
        [/message]
        {VARIABLE tull yes}
        [remove_item]
            x,y=7,38
            halo="items/gohere-empty.png"
        [/remove_item]
        {PLACE_IMAGE scenery/temple-cracked3.png 7 38}
    [/event]
    [event]
        name=die
        [filter]
            side=2
            id=Brother_Jehan
        [/filter]
        [message]
            speaker=Niraliza
            message= _ "May his soul be commended to the light."
        [/message]
        {FIRE_JETHRO_PLAGUE_CONVO}
        # If he doesn't know by now, what has the player been doing?
        [message]
            speaker=Grapvin
            message= _ "If plague alone is responsible for these deaths, why has the village burned? Why are there no corpses laying around? Wouldn't the people have died?"
        [/message]
        [message]
            speaker=Niraliza
            message= _ "I...I don't know. This is beyond what I have learned. We must report what we have witnessed to Brother Wisserl. Perhaps he and the council will know."
        [/message]
        [message]
            speaker=Grapvin
            message= _ "I have a suspicion that more is afoot here than just a plague. We should investigate further."
        [/message]
        [message]
            speaker=Jethro
            message= _ "I know someone who might know something about what's been going on here. His name is Begar, and his farm is just a few miles to the east. We oughta get there before nightfall."
        [/message]
        [message]
            speaker=Grapvin
            message= _ "Well, that is a plan. We shall go find this friend of yours."
        [/message]
        {HIGHLIGHT_IMAGE 24 38 "items/gohere.png" ""}
        [show_objectives]
            side=1
        [/show_objectives]
    [/event]

    # The actual destination
    [event]
        name=moveto
        [filter]
            x,y=24,38
            side=1
        [/filter]
        [endlevel]
            result=victory
            bonus=no
            carryover_percentage=100
            carryover_report=yes
        [/endlevel]
    [/event]

    [event]
        name=scenario_end
        {CLEAR_VARIABLE back_to_the_family,tull,jethro_knows_about_plague,is_afternoon}
    [/event]

    {KILL_A_BOAR 1 boar_kill_count}
    {HERODEATHS}
[/scenario]

#undef PLACE_BUILDINGS
#undef REPLACE_BUILDINGS
#undef JETHRO_PLAGUE_CONVO
#undef REPLACE_JETHROS_HOUSE
#undef REPLACE_TEMPLE
